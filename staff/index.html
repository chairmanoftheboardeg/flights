<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EGR Flights | Staff Dashboard</title>
  <link rel="icon" type="image/png" href="../assets/logo.png"/>
  <link rel="stylesheet" href="../assets/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header class="nav">
  <div class="container nav-inner">
    <a class="brand" href="../index.html" aria-label="EGR Flights">
      <img src="../assets/logo.png" alt="EGR Logo"/>
      <div class="title">
        <b>Emirates Group Roblox</b>
        <span>Staff Dashboard</span>
      </div>
    </a>

    <nav class="nav-links" aria-label="Primary">
      <a href="https://emiratesgrouproblox.link" target="_blank" rel="noopener">Main Website</a>
      <a href="https://directory.emiratesgrouproblox.link" target="_blank" rel="noopener">Directory</a>
      <a href="https://careers.emiratesgrouproblox.link" target="_blank" rel="noopener">Careers</a>
      <a href="https://emiratesgrouproblox.link/socials" target="_blank" rel="noopener">Socials</a>
      <a href="#" id="logoutLink">Logout</a>
      <div class="pill" id="themeToggle" role="button" aria-label="Toggle theme">
        <span class="dot"></span>
        <span class="moon">â˜¾</span>
        <span class="label">Dark</span>
      </div>
    </nav>
  </div>
</header>


<main>
  <section class="hero">
    <div class="container">
      <div class="hero-card">
        <div class="hero-left">
          <div class="kicker"><span class="badge"></span><span>My Dashboard</span><span>â€¢</span><span id="welcome">Loadingâ€¦</span></div>
          <h1>Your flights,<br/>your responses.</h1>
          <p>
            View your rostered assignments, respond to slots, and submit training requests.
            OCC will handle replacements and roster locks.
          </p>
          <div class="hero-actions">
            <a class="btn primary" href="#roster">My Roster</a>
            <a class="btn" href="#training">Training</a>
          </div>
        </div>

        <div class="hero-right">
          <div class="statbox">
            <div class="stat"><div><b id="statAssigned">â€”</b><br/><span>Assigned slots</span></div><span>ðŸ§¾</span></div>
            <div class="sep"></div>
            <div class="stat"><div><b id="statUpcoming">â€”</b><br/><span>Upcoming flights</span></div><span>ðŸ›«</span></div>
            <div class="sep"></div>
            <div class="stat"><div><b id="statTraining">â€”</b><br/><span>Training requests</span></div><span>ðŸŽ“</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="roster">
    <div class="container">
      <div class="section-title">
        <div>
          <h2>My Roster</h2>
          <p class="sub">Only your assigned flights are shown here.</p>
        </div>
        <div class="tiny" id="tzLabel"></div>
      </div>

      <div class="weekbar">
        <div class="meta-row">
          <div class="search">
            <span style="opacity:.75">âŒ•</span>
            <input id="searchBox" placeholder="Search flight number or routeâ€¦" autocomplete="off"/>
          </div>
          <select class="select" id="respFilter">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="accepted">Accepted</option>
            <option value="declined">Declined</option>
          </select>
        </div>

        <div class="grid" id="cards"></div>
        <div id="empty" class="empty" style="display:none; margin-top:14px;">
          No roster slots match your filters.
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="training">
    <div class="container">
      <div class="section-title">
        <div>
          <h2>Training</h2>
          <p class="sub">Submit a training request. Instructors can claim and schedule you.</p>
        </div>
      </div>

      <div class="weekbar">
        <div class="row2">
          <div class="form" style="margin:0;">
            <div class="field">
              <label>Requested role</label>
              <select class="select" id="requestedRole" style="width:100%;">
                <option value="">Select a roleâ€¦</option>
              </select>
            </div>
            <div class="field">
              <label>Notes (optional)</label>
              <textarea id="trainingNotes" placeholder="What do you need help with? Any availability notes?"></textarea>
            </div>
            <button class="btn primary" id="submitTraining">Submit training request</button>
          </div>

          <div class="form" style="margin:0;">
            <b style="display:block; margin-bottom:8px;">My requests</b>
            <div id="trainingList" class="tiny" style="color: var(--muted);">Loadingâ€¦</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>


<footer class="footer">
  <div class="container">
    <div class="row">
      <div>
        <b>Emirates Group Roblox</b>
        <div class="tiny">Owned &amp; Operated by <a href="https://tylernicholasgroup.com" target="_blank" rel="noopener">The Tyler Nicholas Group</a>.</div>
      </div>
      <div class="tiny">Â© <span id="year"></span> Emirates Group Roblox. All Rights Reserved.</div>
    </div>
    <div class="hr"></div>
    <div class="tiny">This platform is for internal scheduling and public flight board display. Access to staff areas is restricted to invited accounts.</div>
  </div>
</footer>


<script type="module">
  import { initThemeToggle } from "../assets/theme.js";
  import { supabase } from "../assets/supabase-client.js";
  import { fmtTime, durationHhMm, toast, revealOnScroll } from "../assets/shared.js";

  initThemeToggle(document.getElementById("themeToggle"));
  document.getElementById("year").textContent = new Date().getFullYear();
  document.getElementById("tzLabel").textContent = "Timezone: " + Intl.DateTimeFormat().resolvedOptions().timeZone;

  const cardsEl = document.getElementById("cards");
  const emptyEl = document.getElementById("empty");

  let user = null;
  let profile = null;
  let roster = [];
  let training = [];
  let roleTemplates = [];

  async function requireAuth(){
    const { data: { session } } = await supabase.auth.getSession();
    if(!session) {
      window.location.href = "../login.html";
      return false;
    }
    const { data } = await supabase.auth.getUser();
    user = data.user;

    const { data: prof, error } = await supabase
      .from("profiles")
      .select("id, display_name, is_staff, is_occ, is_instructor, is_admin")
      .eq("id", user.id)
      .single();

    if(error || !prof) {
      toast("Profile not found. Contact administration.");
      return false;
    }
    profile = prof;

    if(!(profile.is_staff || profile.is_occ || profile.is_instructor || profile.is_admin)) {
      window.location.href = "../not-authorised.html";
      return false;
    }

    document.getElementById("welcome").textContent = prof.display_name ? prof.display_name : (user.email || "Staff");
    return true;
  }

  function rosterCard(item){
    const f = item.flight;
    const std = fmtTime(f.std);
    const sta = fmtTime(f.sta);
    const dep = f.origin_code || f.origin_name || "DEP";
    const arr = f.destination_code || f.destination_name || "ARR";
    const dur = durationHhMm(f.std, f.sta);

    const stage = String(f.stage||"").replaceAll("_"," ");
    const status = String(f.status||"").replaceAll("_"," ");
    const resp = (item.response || "pending").toLowerCase();

    const locked = !!item.locked;

    const actions = `
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
        <button class="btn" data-act="accept" data-id="${item.id}">Accept</button>
        <button class="btn" data-act="decline" data-id="${item.id}">Decline</button>
        <button class="btn ghost" data-act="remove" data-id="${item.id}" ${locked ? "disabled" : ""}>Remove myself</button>
      </div>
    `;

    return `
      <div class="card">
        <div class="card-inner">
          <div class="airline">
            <div class="logo"><img src="../assets/logo.png" alt="EGR"/></div>
            <div>
              <b>${f.flight_number} â€¢ ${item.slot_role}</b>
              <span>Response: ${resp}${locked ? " â€¢ Locked" : ""}</span>
            </div>
          </div>

          <div class="map">
            <div class="badges">
              <div class="badge stage">${stage}</div>
              <div class="badge status">${status}</div>
            </div>
            <div class="duration">${dur}</div>

            <div class="route">
              <div class="timeblock">
                <div class="t">${std}</div>
                <div class="place">${dep}</div>
                <div class="label">Departure</div>
              </div>

              <div class="centerline" aria-hidden="true">
                <div class="pin"></div>
              </div>

              <div class="timeblock" style="text-align:right">
                <div class="t">${sta}</div>
                <div class="place">${arr}</div>
                <div class="label">Arrival</div>
              </div>
            </div>
          </div>
        </div>

        <div class="note">
          <div class="kv">
            ${f.terminal ? `<span>Terminal: ${f.terminal}</span>` : ""}
            ${f.gate ? `<span>Gate: ${f.gate}</span>` : ""}
          </div>
          ${actions}
          <div class="tiny" style="margin-top:10px; color: var(--muted2);">
            Staff can remove themselves unless the slot is locked by OCC.
          </div>
        </div>
      </div>
    `;
  }

  function renderRoster(){
    const q = (document.getElementById("searchBox").value || "").trim().toLowerCase();
    const filter = document.getElementById("respFilter").value;

    let list = roster.slice();

    // sort by flight std
    list.sort((a,b)=> new Date(a.flight.std) - new Date(b.flight.std));

    if(q){
      list = list.filter(r => {
        const f = r.flight;
        const hay = `${f.flight_number} ${f.origin_code||""} ${f.destination_code||""} ${r.slot_role}`.toLowerCase();
        return hay.includes(q);
      });
    }

    if(filter !== "all"){
      list = list.filter(r => (r.response || "pending") === filter);
    }

    cardsEl.innerHTML = list.map(rosterCard).join("");
    emptyEl.style.display = list.length ? "none" : "block";
    revealOnScroll();

    // stats
    document.getElementById("statAssigned").textContent = roster.length;
    const now = new Date();
    const upcoming = roster.filter(r => new Date(r.flight.std) > now).length;
    document.getElementById("statUpcoming").textContent = upcoming;
  }

  async function loadRoster(){
    const { data, error } = await supabase
      .from("roster_slots")
      .select("id, slot_role, response, locked, flight:flights(id, flight_number, origin_code, origin_name, destination_code, destination_name, std, sta, terminal, gate, stage, status, status_note)")
      .eq("assigned_user", user.id);

    if(error) {
      console.error(error);
      toast("Could not load roster.");
      roster = [];
    } else {
      roster = data || [];
    }
    renderRoster();
  }

  async function loadRoleTemplates(){
    const { data, error } = await supabase
      .from("roster_role_templates")
      .select("role_name, sort_order, is_active")
      .eq("is_active", true)
      .order("sort_order", { ascending: true });
    roleTemplates = error ? [] : (data || []);
    const sel = document.getElementById("requestedRole");
    sel.innerHTML = '<option value="">Select a roleâ€¦</option>' + roleTemplates.map(r => `<option value="${r.role_name}">${r.role_name}</option>`).join("");
  }

  async function loadTraining(){
    const { data, error } = await supabase
      .from("training_requests")
      .select("id, requested_role, status, created_at")
      .eq("requester", user.id)
      .order("created_at", { ascending: false });

    training = error ? [] : (data || []);
    document.getElementById("statTraining").textContent = training.length;

    const list = training.map(t => {
      const when = new Date(t.created_at).toLocaleString();
      return `â€¢ <b>${t.requested_role}</b> â€” ${t.status || "pending"} <span class="tiny">(${when})</span>`;
    }).join("<br/>");

    document.getElementById("trainingList").innerHTML = list || '<span class="tiny">No requests yet.</span>';
  }

  async function submitTraining(){
    const role = document.getElementById("requestedRole").value;
    const notes = document.getElementById("trainingNotes").value.trim();

    if(!role) return toast("Select a requested role.");

    const payload = {
      requested_role: role,
      requester_note: notes || null
    };

    const { error } = await supabase.from("training_requests").insert(payload);
    if(error) {
      console.error(error);
      toast(error.message || "Could not submit request.");
      return;
    }
    document.getElementById("trainingNotes").value = "";
    toast("Training request submitted.");
    loadTraining();
  }

  async function respond(slotId, action){
    const map = {
      accept: { response: "accepted", responded_at: new Date().toISOString() },
      decline: { response: "declined", responded_at: new Date().toISOString() },
      remove: { response: "removed", responded_at: new Date().toISOString(), assigned_user: null }
    };
    const patch = map[action];
    if(!patch) return;

    // Decline: ask for a short note (optional)
    if(action === "decline") {
      const note = prompt("Optional: reason / availability note (leave blank to skip):") || "";
      if(note.trim()) patch.response_note = note.trim();
    }

    const { error } = await supabase.from("roster_slots").update(patch).eq("id", slotId);
    if(error) {
      console.error(error);
      toast(error.message || "Could not update slot.");
      return;
    }
    toast("Roster updated.");
    loadRoster();
  }

  cardsEl.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    const id = btn.getAttribute("data-id");
    if(act === "remove") {
      if(!confirm("Remove yourself from this assignment? OCC may reassign the slot.")) return;
    }
    respond(id, act);
  });

  document.getElementById("searchBox").addEventListener("input", renderRoster);
  document.getElementById("respFilter").addEventListener("change", renderRoster);
  document.getElementById("submitTraining").addEventListener("click", submitTraining);

  document.getElementById("logoutLink").addEventListener("click", async (e)=>{
    e.preventDefault();
    await supabase.auth.signOut();
    window.location.href = "../index.html";
  });

  // Boot
  if(await requireAuth()) {
    await Promise.all([loadRoleTemplates(), loadRoster(), loadTraining()]);
  }
</script>
</body>
</html>
