<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Dashboard â€” Emirates Group Roblox OCC</title>
  <meta name="description" content="Live virtual flight dashboard for Emirates Airlines (Unified) and flydubai, operated by Emirates Group Roblox OCC." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand-red:#c20e1a;
      --brand-red-dark:#8b0b13;
      --brand-gold:#d1a23a;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg-page:#f4f5f7;
      --bg-card:#ffffff;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 18px 40px rgba(15,23,42,.14);
      --shadow-subtle:0 4px 12px rgba(15,23,42,.10);

      --status-green:#16a34a;
      --status-blue:#2563eb;
      --status-amber:#d97706;
      --status-red:#dc2626;
      --status-grey:#4b5563;

      --airline-emirates:#c20e1a;
      --airline-flydubai:#f97316;
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at top left,#fef2f2 0,transparent 55%),
        radial-gradient(circle at bottom right,#e0f2fe 0,transparent 55%),
        var(--bg-page);
      color:var(--ink);
      min-height:100vh;
    }
    a{color:var(--brand-red);text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* NAVBAR ----------------------------------------------------------- */
    .site-header{
      background:var(--brand-red);
      color:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.16);
      position:sticky;
      top:0;
      z-index:40;
    }
    .site-header-inner{
      max-width:1200px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .nav-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:96px;
      height:30px;
      border-radius:6px;
      background:linear-gradient(180deg,#e51b24,#b3101a);
      position:relative;
      overflow:hidden;
      box-shadow:var(--shadow-subtle);
    }
    .brand-logo::after{
      content:"EGR";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      letter-spacing:.16em;
      font-size:.9rem;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-text span:first-child{
      font-weight:700;
      font-size:1rem;
    }
    .brand-text span:last-child{
      font-size:.78rem;
      opacity:.9;
    }
    .nav-links{
      display:flex;
      gap:12px;
      font-size:.86rem;
      flex-wrap:wrap;
    }
    .nav-links a{
      color:#fee2e2;
      padding:4px 8px;
      border-radius:999px;
    }
    .nav-links a:hover{
      background:rgba(255,255,255,.12);
      color:#fff;
      text-decoration:none;
    }
    .nav-right{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-size:.78rem;
    }
    .time-chip{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
    }
    .time-main{font-weight:600;font-size:.9rem;}

    /* PAGE LAYOUT ------------------------------------------------------ */
    .page-main{
      max-width:1200px;
      margin:0 auto;
      padding:18px 18px 32px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* WEEKLY SCHEDULE + SEARCH ---------------------------------------- */
    .schedule-shell{
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      border:1px solid var(--line);
      box-shadow:var(--shadow-soft);
      padding:14px 16px 12px;
    }
    .schedule-top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .schedule-label{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size:.95rem;
    }
    .schedule-label span.icon{
      width:20px;height:20px;border-radius:6px;
      border:1px solid #fecaca;
      display:flex;align-items:center;justify-content:center;
      font-size:.8rem;
      background:#fee2e2;
      color:#b91c1c;
    }
    .search-wrap{
      max-width:260px;
      flex:1;
      min-width:180px;
    }
    .search-input{
      width:100%;
      border-radius:999px;
      border:1px solid var(--line);
      padding:7px 12px;
      font-size:.86rem;
      outline:none;
    }
    .search-input:focus{
      border-color:var(--brand-red);
      box-shadow:0 0 0 1px rgba(194,14,26,.15);
    }

    .week-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
      margin-top:4px;
    }
    .week-nav-btn{
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      width:28px;
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      cursor:pointer;
    }
    .week-nav-btn:hover{background:#e5e7eb;}
    .week-strip{
      display:flex;
      overflow-x:auto;
      gap:8px;
      padding-bottom:2px;
    }
    .week-pill{
      min-width:130px;
      border-radius:var(--radius-md);
      border:1px solid var(--line);
      background:#f9fafb;
      padding:6px 10px;
      font-size:.78rem;
      display:flex;
      flex-direction:column;
      gap:2px;
      cursor:pointer;
      flex-shrink:0;
    }
    .week-pill-main{font-weight:600;font-size:.86rem;}
    .week-pill-day{color:var(--muted);}
    .week-pill-flights{color:var(--muted);}
    .week-pill.active{
      background:var(--brand-red);
      border-color:var(--brand-red-dark);
      color:#fff;
    }
    .week-pill.active .week-pill-day,
    .week-pill.active .week-pill-flights{
      color:#fee2e2;
    }

    .date-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      font-size:.8rem;
      color:var(--muted);
    }
    .date-heading{
      font-weight:600;
      color:var(--ink);
      font-size:.9rem;
    }

    /* FLIGHTS LIST ----------------------------------------------------- */
    .flights-section{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .empty-state{
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      border:1px dashed var(--line);
      padding:18px 16px;
      text-align:center;
      font-size:.9rem;
      color:var(--muted);
    }

    .flight-card{
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      border:1px solid var(--line);
      padding:14px 16px;
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(0,3fr) minmax(0,1.8fr);
      gap:14px;
      align-items:center;
      box-shadow:var(--shadow-soft);
    }
    @media(max-width:900px){
      .flight-card{
        grid-template-columns:minmax(0,1fr);
        align-items:flex-start;
      }
    }

    .flight-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .airline-logo{
      width:42px;height:42px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      color:#fff;
      font-size:.7rem;font-weight:700;text-transform:uppercase;
      box-shadow:var(--shadow-subtle);
    }
    .airline-logo.emirates{background:var(--airline-emirates);}
    .airline-logo.flydubai{background:var(--airline-flydubai);}

    .flight-left-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .flight-number{font-weight:700;font-size:1.05rem;}
    .flight-airline{font-size:.8rem;color:var(--muted);}
    .flight-extra{
      font-size:.78rem;
      color:var(--muted);
    }

    .flight-middle{
      display:grid;
      grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);
      gap:8px;
      align-items:center;
    }
    .time-block{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .time-main{font-size:1.6rem;font-weight:700;}
    .time-city{font-size:.9rem;}
    .time-label{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .timeline{
      text-align:center;font-size:.8rem;color:var(--muted);
    }
    .timeline-arrow{
      width:80px;height:2px;border-radius:999px;
      background:linear-gradient(90deg,#6ee7b7,#16a34a);
      margin:4px auto 6px;position:relative;
    }
    .timeline-arrow::after{
      content:"";
      position:absolute;
      right:0;top:-4px;
      width:10px;height:10px;border-radius:999px;
      border:2px solid #16a34a;background:#fff;
    }

    .flight-right{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 11px;
      border-radius:999px;
      font-size:.78rem;
      font-weight:600;
      border:1px solid transparent;
      cursor:default;
      white-space:nowrap;
    }
    .status-On-Time{
      background:#ecfdf5;border-color:#bbf7d0;color:var(--status-green);
    }
    .status-Boarding,
    .status-Live{
      background:#eff6ff;border-color:#bfdbfe;color:var(--status-blue);
    }
    .status-Delayed{
      background:#fef3c7;border-color:#fde68a;color:var(--status-amber);
    }
    .status-Cancelled{
      background:#fee2e2;border-color:#fecaca;color:var(--status-red);
    }
    .status-Landed{
      background:#f1f5f9;border-color:#e5e7eb;color:var(--status-grey);
    }
    .status-clickable{cursor:pointer;}

    .gate-info{font-size:.8rem;color:var(--muted);}
    .gate-info span{font-weight:600;color:var(--ink);}
    .remarks{font-size:.78rem;color:var(--muted);max-width:260px;text-align:right;}

    .card-actions{
      display:flex;gap:6px;margin-top:4px;
    }
    .btn-small{
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      padding:2px 8px;
      font-size:.76rem;
      display:inline-flex;
      align-items:center;
      cursor:pointer;
    }
    .btn-small:hover{background:#fee2e2;border-color:#fecaca;}

    /* OCC PANEL -------------------------------------------------------- */
    .occ-shell{
      margin-top:4px;
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      border:1px solid var(--line);
      box-shadow:var(--shadow-soft);
      padding:14px 16px 16px;
    }
    .occ-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .occ-header h2{
      margin:0;
      font-family:Merriweather,Georgia,serif;
      font-size:1.25rem;
    }
    .occ-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:.78rem;
      border:1px solid #bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .occ-badge span.dot{
      width:8px;height:8px;border-radius:999px;background:#22c55e;
    }

    .form-row{margin-bottom:8px;}
    .form-label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-size:.84rem;
      font-weight:600;
      margin-bottom:3px;
    }
    .form-label span.hint{
      font-weight:400;
      color:#9ca3af;
      font-size:.76rem;
    }
    .form-input,
    .form-select,
    .form-textarea{
      width:100%;
      border-radius:10px;
      border:1px solid var(--line);
      padding:7px 10px;
      font-size:.86rem;
      font-family:inherit;
      outline:none;
      background:#fff;
    }
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus{
      border-color:var(--brand-red);
      box-shadow:0 0 0 1px rgba(194,14,26,.15);
    }
    .form-textarea{min-height:50px;resize:vertical;}

    .btn-primary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      border:none;
      background:var(--brand-red);
      color:#fff;
      font-weight:600;
      font-size:.86rem;
      cursor:pointer;
      box-shadow:var(--shadow-soft);
    }
    .btn-primary:hover{background:var(--brand-red-dark);}
    .btn-secondary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f3f4f6;
      font-size:.8rem;
      cursor:pointer;
    }
    .btn-secondary:hover{background:#e5e7eb;}
    .btn-block{width:100%;justify-content:center;}

    .status-banner{
      margin-top:8px;
      padding:7px 10px;
      border-radius:10px;
      font-size:.8rem;
      display:none;
    }
    .status-banner.success{
      background:#ecfdf5;color:#15803d;border:1px solid #bbf7d0;
    }
    .status-banner.error{
      background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;
    }

    /* FOOTER ----------------------------------------------------------- */
    footer{
      background:#111827;
      color:#9ca3af;
      border-top:2px solid var(--brand-red);
      margin-top:26px;
      font-size:.8rem;
    }
    .footer-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer-logo{
      width:80px;height:26px;border-radius:4px;
      background:linear-gradient(180deg,#e51b24,#b3101a);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:.75rem;letter-spacing:.16em;
      color:#fff;
    }
    @media(max-width:600px){
      .footer-inner{flex-direction:column;align-items:flex-start;}
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="site-header">
    <div class="site-header-inner">
      <div class="nav-left">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="brand-text">
          <span>Emirates Group Roblox â€” Flight Dashboard</span>
          <span>Emirates Airlines (Unified) Â· flydubai</span>
        </div>
      </div>
      <nav class="nav-links" aria-label="Primary">
        <a href="https://flyemirates.emiratesgrouproblox.link">Main site</a>
        <a href="https://flyemirates.emiratesgrouproblox.link/booking.html">Booking</a>
        <a href="https://flyemirates.emiratesgrouproblox.link/checkin.html">Online check-in</a>
        <a href="#">Dashboard</a>
      </nav>
      <div class="nav-right">
        <div class="time-chip">
          <span class="time-main" id="dubaiTimeHeader">--:--</span>
          <span>Dubai (GMT+4)</span>
        </div>
        <div class="time-chip">
          <span class="time-main" id="localTimeHeader">--:--</span>
          <span>Your local time</span>
        </div>
      </div>
    </div>
  </header>

  <main class="page-main">
    <!-- WEEKLY STRIP + SEARCH -->
    <section class="schedule-shell" aria-label="Weekly schedule">
      <div class="schedule-top-row">
        <div class="schedule-label">
          <span class="icon">ðŸ—“</span>
          <span>Weekly schedule</span>
        </div>
        <div class="search-wrap">
          <input id="searchInput" class="search-input" type="text"
                 placeholder="Search by flight number (e.g. EKU101)">
        </div>
      </div>

      <div class="week-row">
        <button type="button" id="prevWeek" class="week-nav-btn" aria-label="Previous week">â€¹</button>
        <div class="week-strip" id="weekStrip"></div>
        <button type="button" id="nextWeek" class="week-nav-btn" aria-label="Next week">â€º</button>
      </div>

      <div class="date-row">
        <div class="date-heading" id="selectedDateHeading">Today</div>
        <div>All flight times scheduled in <strong>Dubai local time (GMT+4)</strong>.</div>
      </div>
    </section>

    <!-- FLIGHTS LIST -->
    <section class="flights-section" aria-label="Flights for selected date">
      <div id="flightsContainer"></div>
    </section>

    <!-- OCC PANEL -->
    <section class="occ-shell" aria-label="OCC tools">
      <!-- Logged out -->
      <div id="occLoggedOut">
        <div class="occ-header">
          <h2>OCC login</h2>
        </div>
        <form id="loginForm">
          <div class="form-row">
            <label class="form-label" for="occPassword">
              OCC password
              <span class="hint">Authorized Operations Control Center staff only</span>
            </label>
            <input id="occPassword" class="form-input" type="password" required>
          </div>
          <button type="submit" class="btn-primary btn-block">Sign in to OCC</button>
        </form>
        <div id="loginStatus" class="status-banner error"></div>
      </div>

      <!-- Logged in -->
      <div id="occLoggedIn" style="display:none;">
        <div class="occ-header">
          <h2>OCC tools</h2>
          <div class="occ-badge">
            <span class="dot"></span>
            <span>Session active</span>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap;">
          <span style="font-size:.8rem;color:var(--muted);">Add, edit or delete flights for the dashboard above.</span>
          <button type="button" id="btnLogout" class="btn-secondary">Log out</button>
        </div>

        <form id="flightForm">
          <input type="hidden" id="editingId" value="">

          <div class="form-row">
            <label class="form-label" for="flightDate">
              Flight date
              <span class="hint">Day / month / year</span>
            </label>
            <input id="flightDate" class="form-input" type="date" required>
          </div>

          <div class="form-row">
            <label class="form-label" for="flightNumber">
              Flight number
              <span class="hint">e.g. EKU101, FZ45</span>
            </label>
            <input id="flightNumber" class="form-input" required>
          </div>

          <div class="form-row">
            <label class="form-label" for="airlineSelect">Airline</label>
            <select id="airlineSelect" class="form-select" required>
              <option value="Emirates Airlines (Unified)">Emirates Airlines (Unified)</option>
              <option value="flydubai">flydubai</option>
            </select>
          </div>

          <div class="form-row">
            <label class="form-label" for="aircraftInput">
              Aircraft type
              <span class="hint">e.g. B777-300ER, A380, B737-800</span>
            </label>
            <input id="aircraftInput" class="form-input" required>
          </div>

          <div class="form-row">
            <label class="form-label" for="simSelect">
              Simulator
              <span class="hint">PTFS / ROAV / N/A</span>
            </label>
            <select id="simSelect" class="form-select" required>
              <option value="PTFS">PTFS</option>
              <option value="ROAV">ROAV</option>
              <option value="N/A">N/A</option>
            </select>
          </div>

          <div class="form-row">
            <label class="form-label" for="fromInput">From (airport)</label>
            <input id="fromInput" class="form-input" placeholder="Dubai International (DXB)" required>
          </div>

          <div class="form-row">
            <label class="form-label" for="toInput">To (airport)</label>
            <input id="toInput" class="form-input" placeholder="Greater Rockford International" required>
          </div>

          <div class="form-row" style="display:flex;gap:10px;">
            <div style="flex:1;">
              <label class="form-label" for="depInput">Departure time (Dubai)</label>
              <input id="depInput" class="form-input" placeholder="08:35" required>
            </div>
            <div style="flex:1;">
              <label class="form-label" for="arrInput">Arrival time (Dubai)</label>
              <input id="arrInput" class="form-input" placeholder="13:10" required>
            </div>
          </div>

          <div class="form-row">
            <label class="form-label" for="statusSelect">Status</label>
            <select id="statusSelect" class="form-select">
              <option value="On Time">On Time</option>
              <option value="Boarding">Boarding</option>
              <option value="Live">Live</option>
              <option value="Landed">Landed</option>
              <option value="Delayed">Delayed</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>

          <div class="form-row">
            <label class="form-label" for="gateInput">Gate / stand</label>
            <input id="gateInput" class="form-input" placeholder="A12, Remote, Hangar 3">
          </div>

          <div class="form-row">
            <label class="form-label" for="remarksInput">
              Remarks
              <span class="hint">optional, e.g. training, investor event, delay reason</span>
            </label>
            <textarea id="remarksInput" class="form-textarea"></textarea>
          </div>

          <button type="submit" class="btn-primary btn-block" id="btnSaveFlight">Add flight</button>
          <button type="button" class="btn-secondary btn-block" id="btnCancelEdit" style="margin-top:6px;display:none;">Cancel edit</button>
        </form>

        <div id="occStatus" class="status-banner success"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-inner">
      <span>
        Â© 2025 Emirates Group Roblox. All rights reserved. This virtual dashboard is not affiliated with, sponsored by,
        or endorsed by Emirates or the Emirates Group.
      </span>
      <div class="footer-logo">EGR</div>
    </div>
  </footer>

  <script>
    // ---------- CONFIG ----------
    const OCC_PASSWORD = "EmiratesGroupRobloxOCC#2025";
    const STORAGE_KEY_FLIGHTS = "egr_flights_schedule_v3";
    const STORAGE_KEY_OCC = "egr_occ_logged_in_v2";
    const STATUS_SEQUENCE = ["On Time","Boarding","Live","Landed","Delayed","Cancelled"];

    // ---------- STATE ----------
    let flights = [];
    let occLoggedIn = false;
    let weekOffsetDays = 0; // multiple of 7
    let selectedDateKey = null; // "YYYY-MM-DD"

    // ---------- DOM ----------
    const dubaiTimeHeader = document.getElementById("dubaiTimeHeader");
    const localTimeHeader = document.getElementById("localTimeHeader");
    const weekStrip = document.getElementById("weekStrip");
    const selectedDateHeading = document.getElementById("selectedDateHeading");
    const flightsContainer = document.getElementById("flightsContainer");
    const searchInput = document.getElementById("searchInput");

    const occLoggedOut = document.getElementById("occLoggedOut");
    const occLoggedInEl = document.getElementById("occLoggedIn");
    const loginForm = document.getElementById("loginForm");
    const loginStatus = document.getElementById("loginStatus");
    const btnLogout = document.getElementById("btnLogout");
    const occStatus = document.getElementById("occStatus");

    const flightForm = document.getElementById("flightForm");
    const editingIdInput = document.getElementById("editingId");
    const btnSaveFlight = document.getElementById("btnSaveFlight");
    const btnCancelEdit = document.getElementById("btnCancelEdit");

    const flightDateInput = document.getElementById("flightDate");
    const flightNumberInput = document.getElementById("flightNumber");
    const airlineSelect = document.getElementById("airlineSelect");
    const aircraftInput = document.getElementById("aircraftInput");
    const simSelect = document.getElementById("simSelect");
    const fromInput = document.getElementById("fromInput");
    const toInput = document.getElementById("toInput");
    const depInput = document.getElementById("depInput");
    const arrInput = document.getElementById("arrInput");
    const statusSelect = document.getElementById("statusSelect");
    const gateInput = document.getElementById("gateInput");
    const remarksInput = document.getElementById("remarksInput");

    // ---------- TIME ----------
    function pad2(n){return n.toString().padStart(2,"0");}

    function updateTime(){
      const now = new Date();
      // local
      localTimeHeader.textContent = now.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      // Dubai (UTC+4)
      const utc = now.getTime() + now.getTimezoneOffset()*60000;
      const dubai = new Date(utc + 4*3600000);
      dubaiTimeHeader.textContent = dubai.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
    }
    updateTime();
    setInterval(updateTime, 1000);

    // ---------- STORAGE ----------
    function loadFlights(){
      const stored = localStorage.getItem(STORAGE_KEY_FLIGHTS);
      if(stored){
        try{
          const parsed = JSON.parse(stored);
          if(Array.isArray(parsed)) flights = parsed;
        }catch(e){ flights = []; }
      }
    }
    function saveFlights(){
      localStorage.setItem(STORAGE_KEY_FLIGHTS, JSON.stringify(flights));
      renderWeekStrip();
      renderFlights();
    }
    function setOCCLoggedIn(value){
      occLoggedIn = value;
      if(value){
        occLoggedOut.style.display="none";
        occLoggedInEl.style.display="block";
        localStorage.setItem(STORAGE_KEY_OCC,"1");
      }else{
        occLoggedOut.style.display="block";
        occLoggedInEl.style.display="none";
        localStorage.removeItem(STORAGE_KEY_OCC);
      }
      renderFlights();
    }
    function showBanner(el,type,msg){
      el.style.display="block";
      el.className = "status-banner " + type;
      el.textContent = msg;
      setTimeout(()=>{ el.style.display="none"; }, 3500);
    }

    function resetForm(){
      editingIdInput.value="";
      flightDateInput.value="";
      flightNumberInput.value="";
      airlineSelect.value="Emirates Airlines (Unified)";
      aircraftInput.value="";
      simSelect.value="PTFS";
      fromInput.value="";
      toInput.value="";
      depInput.value="";
      arrInput.value="";
      statusSelect.value="On Time";
      gateInput.value="";
      remarksInput.value="";
      btnSaveFlight.textContent="Add flight";
      btnCancelEdit.style.display="none";
    }

    // ---------- WEEK STRIP ----------
    function dateToKey(d){
      const year = d.getFullYear();
      const month = pad2(d.getMonth()+1);
      const day = pad2(d.getDate());
      return `${year}-${month}-${day}`;
    }
    function keyToReadable(key){
      const d = new Date(key + "T00:00:00");
      return d.toLocaleDateString([], {weekday:"long",day:"2-digit",month:"short",year:"numeric"});
    }
    function buildWeekDays(){
      const ref = new Date();
      ref.setDate(ref.getDate() + weekOffsetDays);
      // Monday as start of week
      const jsDay = ref.getDay(); // Sun=0
      const mondayOffset = (jsDay + 6) % 7;
      const monday = new Date(ref);
      monday.setDate(ref.getDate() - mondayOffset);

      const days = [];
      for(let i=0;i<7;i++){
        const d = new Date(monday);
        d.setDate(monday.getDate()+i);
        days.push(d);
      }
      return days;
    }
    function renderWeekStrip(){
      const days = buildWeekDays();
      if(!selectedDateKey){
        const todayKey = dateToKey(new Date());
        selectedDateKey = todayKey;
      }
      weekStrip.innerHTML="";
      days.forEach(d=>{
        const key = dateToKey(d);
        const wrapper = document.createElement("button");
        wrapper.type="button";
        wrapper.className="week-pill"+(key===selectedDateKey?" active":"");
        wrapper.dataset.dateKey = key;

        const main = document.createElement("div");
        main.className="week-pill-main";
        main.textContent = d.toLocaleDateString([], {day:"2-digit",month:"short"});

        const dayName = document.createElement("div");
        dayName.className="week-pill-day";
        dayName.textContent = d.toLocaleDateString([], {weekday:"long"});

        const count = flights.filter(f=>f.date===key).length;
        const flightsText = document.createElement("div");
        flightsText.className="week-pill-flights";
        flightsText.textContent = count + " flight" + (count===1?"":"s");

        wrapper.appendChild(main);
        wrapper.appendChild(dayName);
        wrapper.appendChild(flightsText);
        wrapper.addEventListener("click",()=>{
          selectedDateKey = key;
          renderWeekStrip();
          renderFlights();
        });

        weekStrip.appendChild(wrapper);
      });

      selectedDateHeading.textContent = keyToReadable(selectedDateKey);
    }

    // ---------- RENDER FLIGHTS ----------
    function renderFlights(){
      flightsContainer.innerHTML="";
      const search = searchInput.value.trim().toLowerCase();

      const forDate = flights
        .filter(f=>f.date===selectedDateKey)
        .sort((a,b)=>{
          if(a.depTime===b.depTime){
            return a.flightNumber.localeCompare(b.flightNumber);
          }
          return a.depTime.localeCompare(b.depTime);
        })
        .filter(f=>{
          if(!search) return true;
          return (f.flightNumber || "").toLowerCase().includes(search);
        });

      if(forDate.length===0){
        const div = document.createElement("div");
        div.className="empty-state";
        div.textContent="No flights scheduled for this date yet. OCC staff can add flights using the tools below.";
        flightsContainer.appendChild(div);
        return;
      }

      forDate.forEach(f=>{
        const card = document.createElement("article");
        card.className="flight-card";

        // LEFT
        const left = document.createElement("div");
        left.className="flight-left";

        const logo = document.createElement("div");
        logo.className="airline-logo "+(f.airline==="flydubai"?"flydubai":"emirates");
        logo.textContent = f.airline==="flydubai"?"FZ":"EKU";

        const leftText = document.createElement("div");
        leftText.className="flight-left-text";

        const num = document.createElement("div");
        num.className="flight-number";
        num.textContent = f.flightNumber;

        const airlineEl = document.createElement("div");
        airlineEl.className="flight-airline";
        airlineEl.textContent = f.airline;

        const extra = document.createElement("div");
        extra.className="flight-extra";
        extra.textContent = `${f.aircraft} Â· ${f.simulator}`;

        leftText.appendChild(num);
        leftText.appendChild(airlineEl);
        leftText.appendChild(extra);

        left.appendChild(logo);
        left.appendChild(leftText);

        // MIDDLE
        const middle = document.createElement("div");
        middle.className="flight-middle";

        const depBlock = document.createElement("div");
        depBlock.className="time-block";
        const depTime = document.createElement("div");
        depTime.className="time-main";
        depTime.textContent = f.depTime;
        const depCity = document.createElement("div");
        depCity.className="time-city";
        depCity.textContent = f.from;
        const depLabel = document.createElement("div");
        depLabel.className="time-label";
        depLabel.textContent = "Departure";
        depBlock.appendChild(depTime);
        depBlock.appendChild(depCity);
        depBlock.appendChild(depLabel);

        const line = document.createElement("div");
        line.className="timeline";
        const arrow = document.createElement("div");
        arrow.className="timeline-arrow";
        const lineText = document.createElement("div");
        lineText.textContent = "Route";
        line.appendChild(arrow);
        line.appendChild(lineText);

        const arrBlock = document.createElement("div");
        arrBlock.className="time-block";
        const arrTime = document.createElement("div");
        arrTime.className="time-main";
        arrTime.textContent = f.arrTime;
        const arrCity = document.createElement("div");
        arrCity.className="time-city";
        arrCity.textContent = f.to;
        const arrLabel = document.createElement("div");
        arrLabel.className="time-label";
        arrLabel.textContent = "Arrival";
        arrBlock.appendChild(arrTime);
        arrBlock.appendChild(arrCity);
        arrBlock.appendChild(arrLabel);

        middle.appendChild(depBlock);
        middle.appendChild(line);
        middle.appendChild(arrBlock);

        // RIGHT
        const right = document.createElement("div");
        right.className="flight-right";

        const status = document.createElement("button");
        status.type="button";
        const statusClass = "status-"+f.status.replace(/\s+/g,"-");
        status.className = "status-pill "+statusClass+(occLoggedIn?" status-clickable":"");
        status.textContent = f.status;
        if(occLoggedIn){
          status.title = "Click to cycle status";
          status.addEventListener("click",()=>cycleStatus(f.id));
        }
        right.appendChild(status);

        const gate = document.createElement("div");
        gate.className="gate-info";
        gate.innerHTML = 'Gate / stand: <span>'+(f.gate||"TBA")+'</span>';
        right.appendChild(gate);

        if(f.remarks){
          const r = document.createElement("div");
          r.className="remarks";
          r.textContent = f.remarks;
          right.appendChild(r);
        }

        if(occLoggedIn){
          const actions = document.createElement("div");
          actions.className="card-actions";

          const editBtn = document.createElement("button");
          editBtn.type="button";
          editBtn.className="btn-small";
          editBtn.textContent="âœ Edit";
          editBtn.addEventListener("click",()=>startEditFlight(f.id));

          const delBtn = document.createElement("button");
          delBtn.type="button";
          delBtn.className="btn-small";
          delBtn.textContent="ðŸ—‘ Delete";
          delBtn.addEventListener("click",()=>deleteFlight(f.id));

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          right.appendChild(actions);
        }

        card.appendChild(left);
        card.appendChild(middle);
        card.appendChild(right);

        flightsContainer.appendChild(card);
      });
    }

    // ---------- OCC ACTIONS ----------
    function startEditFlight(id){
      const f = flights.find(fl=>fl.id===id);
      if(!f) return;
      editingIdInput.value = f.id;
      flightDateInput.value = f.date;
      flightNumberInput.value = f.flightNumber;
      airlineSelect.value = f.airline;
      aircraftInput.value = f.aircraft;
      simSelect.value = f.simulator;
      fromInput.value = f.from;
      toInput.value = f.to;
      depInput.value = f.depTime;
      arrInput.value = f.arrTime;
      statusSelect.value = f.status;
      gateInput.value = f.gate || "";
      remarksInput.value = f.remarks || "";
      btnSaveFlight.textContent = "Save changes";
      btnCancelEdit.style.display="inline-flex";
      flightDateInput.scrollIntoView({behavior:"smooth",block:"center"});
    }

    function deleteFlight(id){
      const f = flights.find(fl=>fl.id===id);
      if(!f) return;
      if(!confirm("Delete flight "+f.flightNumber+" from this dashboard?")) return;
      flights = flights.filter(fl=>fl.id!==id);
      saveFlights();
      showBanner(occStatus,"success","Flight "+f.flightNumber+" deleted.");
    }

    function cycleStatus(id){
      const f = flights.find(fl=>fl.id===id);
      if(!f) return;
      const idx = STATUS_SEQUENCE.indexOf(f.status);
      const next = STATUS_SEQUENCE[(idx+1)%STATUS_SEQUENCE.length];
      f.status = next;
      saveFlights();
    }

    // ---------- EVENTS ----------
    document.getElementById("prevWeek").addEventListener("click",()=>{
      weekOffsetDays -= 7;
      renderWeekStrip();
      renderFlights();
    });
    document.getElementById("nextWeek").addEventListener("click",()=>{
      weekOffsetDays += 7;
      renderWeekStrip();
      renderFlights();
    });
    searchInput.addEventListener("input",renderFlights);

    loginForm.addEventListener("submit",e=>{
      e.preventDefault();
      const val = document.getElementById("occPassword").value;
      if(val === OCC_PASSWORD){
        document.getElementById("occPassword").value="";
        setOCCLoggedIn(true);
        showBanner(occStatus,"success","OCC login successful.");
      }else{
        showBanner(loginStatus,"error","Incorrect OCC password.");
      }
    });

    btnLogout.addEventListener("click",()=>{
      if(!confirm("Log out of OCC tools on this device?")) return;
      setOCCLoggedIn(false);
      resetForm();
    });

    flightForm.addEventListener("submit",e=>{
      e.preventDefault();
      const id = editingIdInput.value;
      const date = flightDateInput.value;
      const flightNumber = flightNumberInput.value.trim();
      const airline = airlineSelect.value;
      const aircraft = aircraftInput.value.trim();
      const simulator = simSelect.value;
      const from = fromInput.value.trim();
      const to = toInput.value.trim();
      const depTime = depInput.value.trim();
      const arrTime = arrInput.value.trim();
      const status = statusSelect.value;
      const gate = gateInput.value.trim();
      const remarks = remarksInput.value.trim();

      if(!date || !flightNumber || !aircraft || !from || !to || !depTime || !arrTime){
        showBanner(occStatus,"error","Please fill in all required fields.");
        return;
      }

      if(id){
        const idx = flights.findIndex(fl=>fl.id===id);
        if(idx!==-1){
          flights[idx] = {...flights[idx],date,flightNumber,airline,aircraft,simulator,from,to,depTime,arrTime,status,gate,remarks};
        }
        saveFlights();
        showBanner(occStatus,"success","Flight "+flightNumber+" updated.");
      }else{
        const newFlight = {
          id:String(Date.now()),
          date,
          flightNumber,
          airline,
          aircraft,
          simulator,
          from,
          to,
          depTime,
          arrTime,
          status,
          gate,
          remarks
        };
        flights.push(newFlight);
        saveFlights();
        showBanner(occStatus,"success","Flight "+flightNumber+" added.");
      }

      // If we add a flight on a different date, switch to that date so it "goes directly" there
      selectedDateKey = date;
      weekOffsetDays = 0;
      renderWeekStrip();
      renderFlights();
      resetForm();
    });

    btnCancelEdit.addEventListener("click",()=>{
      resetForm();
      showBanner(occStatus,"success","Edit cancelled.");
    });

    // ---------- INIT ----------
    loadFlights();
    selectedDateKey = dateToKey(new Date());
    renderWeekStrip();
    renderFlights();
    if(localStorage.getItem(STORAGE_KEY_OCC)==="1"){
      setOCCLoggedIn(true);
    }else{
      setOCCLoggedIn(false);
    }
  </script>
</body>
</html>
